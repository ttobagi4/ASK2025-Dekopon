# (1) ì´ë¯¸ì§€ ì „ì²˜ë¦¬ - í¬ê¸° ì¡°ì • & HSV ìƒ‰ ê³µê°„ ë³€í™˜ ë° Blur ì ìš©
def preprocess_image(image_path) :

    if not os.path.exists(image_path) :
        raise FileNotFoundError(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.: {image_path}")

    image = cv2.imread(image_path)
    if image is None :
        raise ValueError(f"ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”!: {image_path}")

    resized_image = cv2.resize(image, (512, 512))  # í¬ê¸° ì¡°ì • (512x512)
    hsv_image = cv2.cvtColor(resized_image, cv2.COLOR_BGR2HSV)
    blurred_image = cv2.GaussianBlur(hsv_image, (5, 5), 0)  # # ê°€ìš°ì‹œì•ˆ ë¸”ëŸ¬ (5x5 ì»¤ë„)

    return resized_image, hsv_image, blurred_image

# ğŸ“Œ ì´ˆì (Blur) ê¸°ë°˜ ë§ˆìŠ¤í¬ ìƒì„± (LoG + Otsu ì‚¬ìš©)
def create_blur_mask(image):
    """
    ì´ˆì (Blur) ê¸°ë°˜ ë§ˆìŠ¤í¬ ìƒì„± (LoG + Otsu ì‚¬ìš©)
    íë¦° ë¶€ë¶„ì„ ë°°ê²½ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë§ˆìŠ¤í¬ ìƒì„±.

    Args:
        image (numpy.ndarray): ì›ë³¸ ì´ë¯¸ì§€

    Returns:
        blur_mask (numpy.ndarray): íë¦° ë¶€ë¶„ì´ ë°°ê²½ìœ¼ë¡œ ì²˜ë¦¬ëœ ë§ˆìŠ¤í¬
    """
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

    # ğŸš€ Laplacian of Gaussian ì ìš© (íë¦° ë¶€ë¶„ ê°ì§€)
    gaussian = cv2.GaussianBlur(gray, (5, 5), 0)
    laplacian = cv2.Laplacian(gaussian, cv2.CV_64F)
    laplacian_abs = cv2.convertScaleAbs(laplacian)

    # ğŸš€ Otsu Threshold ì ìš© (ë°°ê²½ ìë™ ê°ì§€)
    _, blur_mask = cv2.threshold(laplacian_abs, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    return blur_mask


def detect_leaf_area(image, hsv_image):
    """
    ì´ë¯¸ì§€ì—ì„œ ì ìœ¤ê³½ì„ ì„ ê²€ì¶œí•˜ëŠ” í•¨ìˆ˜.
    ì ë¬´ëŠ¬ë³‘ì´ ìˆëŠ” ê²½ìš°ì—ë„ ìì„ ì •ìƒì ìœ¼ë¡œ ê²€ì¶œí•˜ë„ë¡ í•„í„°ë¥¼ ì¡°ì •í•¨.

    Args:
        image (numpy.ndarray): ì›ë³¸ ì´ë¯¸ì§€ (512x512ë¡œ ë¦¬ì‚¬ì´ì§•ëœ ìƒíƒœ)
        hsv_image (numpy.ndarray): HSV ë³€í™˜ëœ ì´ë¯¸ì§€

    Returns:
        contours (list): ê²€ì¶œëœ ì ìœ¤ê³½ì„  ë¦¬ìŠ¤íŠ¸
        mask_leaf_cleaned (numpy.ndarray): ìµœì¢… ì ì˜ì—­ ë§ˆìŠ¤í¬
    """

    # âœ… **1. ì íƒì§€ í•„í„° ê°œì„ **
    lower_green = np.array([20, 20, 20])
    upper_green = np.array([100, 255, 255])
    mask_leaf = cv2.inRange(hsv_image, lower_green, upper_green)

    # âœ… **2. Blur Mask ì¶”ê°€ (íë¦° ë°°ê²½ ì œê±°)**
    blur_mask = create_blur_mask(image)
    blur_mask = cv2.resize(blur_mask, (mask_leaf.shape[1], mask_leaf.shape[0]))  # í¬ê¸° ë§ì¶¤
    blur_mask = blur_mask.astype(np.uint8)

    # ğŸš€ blur_maskì™€ ê¸°ì¡´ ì ë§ˆìŠ¤í¬ë¥¼ ê²°í•©í•˜ì—¬ ë°°ê²½ ì œê±°
    mask_leaf_combined = cv2.bitwise_and(mask_leaf, blur_mask)

    # âœ… **3. GrabCut ë§ˆìŠ¤í¬ ì´ˆê¸°í™” ê°œì„ **
    grabcut_mask = np.zeros(image.shape[:2], np.uint8)
    grabcut_mask[mask_leaf_combined > 0] = 1
    grabcut_mask[mask_leaf_combined == 0] = 2

    # âœ… **4. GrabCut ì‹¤í–‰ (ì ë¬´ëŠ¬ë³‘ í¬í•¨)**
    bgd_model = np.zeros((1, 65), np.float64)
    fgd_model = np.zeros((1, 65), np.float64)
    cv2.grabCut(image, grabcut_mask, None, bgd_model, fgd_model, iterCount=5, mode=cv2.GC_INIT_WITH_MASK)

    # âœ… **5. ìµœì¢… ë§ˆìŠ¤í¬ ìƒì„±**
    final_mask = np.where((grabcut_mask == 2) | (grabcut_mask == 0), 0, 1).astype("uint8")

    # âœ… **6. í˜•íƒœí•™ì  ì—°ì‚° ì ìš© (êµ¬ë© ì œê±°)**
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (5, 5))
    mask_leaf_cleaned = cv2.morphologyEx(final_mask, cv2.MORPH_CLOSE, kernel)

    # âœ… **7. ì ìœ¤ê³½ ê²€ì¶œ**
    contours, _ = cv2.findContours(mask_leaf_cleaned, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # âœ… **8. ê°€ì¥ í° ì ìœ¤ê³½ 1ê°œë§Œ ìœ ì§€**
    if contours:
        contours = [max(contours, key=cv2.contourArea)]

    # âœ… **ë””ë²„ê¹…ìš© ì‹œê°í™”**
    fig, axes = plt.subplots(1, 4, figsize=(20, 5))

    axes[0].imshow(mask_leaf, cmap="gray")
    axes[0].set_title("Initial Leaf Mask")
    axes[0].axis("off")

    axes[1].imshow(blur_mask, cmap="gray")
    axes[1].set_title("Blur Mask (Focus-Based)")
    axes[1].axis("off")

    axes[2].imshow(mask_leaf_cleaned, cmap="gray")
    axes[2].set_title("Final Leaf Mask (After Morphology)")
    axes[2].axis("off")

    final_visualization = image.copy()
    cv2.drawContours(final_visualization, contours, -1, (0, 255, 0), 2)
    axes[3].imshow(cv2.cvtColor(final_visualization, cv2.COLOR_BGR2RGB))
    axes[3].set_title("Final Leaf Contour")
    axes[3].axis("off")

    plt.show()

    return contours, mask_leaf_cleaned


# ë³‘ì§• ë¶€ìœ„ ê²€ì¶œ (ì ë‚´ë¶€ë§Œ ìœ ì§€)
def detect_disease_area(hsv_image, leaf_contours):
    """
    ì´ë¯¸ì§€ì—ì„œ ë³‘ì§• ë¶€ìœ„ë¥¼ ê²€ì¶œí•˜ê³ , ì ë‚´ë¶€ì— í¬í•¨ëœ ë³‘ì§•ë§Œ ìœ ì§€í•˜ëŠ” í•¨ìˆ˜.

    Args:
        hsv_image (numpy.ndarray): HSV ë³€í™˜ëœ ì´ë¯¸ì§€
        leaf_contours (list): ê²€ì¶œëœ ì ìœ¤ê³½ì„  ë¦¬ìŠ¤íŠ¸

    Returns:
        valid_disease_contours (list): ì ë‚´ë¶€ì— í¬í•¨ëœ ë³‘ì§• ìœ¤ê³½ì„  ë¦¬ìŠ¤íŠ¸
        mask_disease_cleaned (numpy.ndarray): ë³‘ì§• ì˜ì—­ ë§ˆìŠ¤í¬
    """
    lower_brown = np.array([8, 80, 15])   # H ê°’ì„ 10 â†’ 8ë¡œ ë‚®ì¶”ê³ , S/Vë„ ì¡°ê¸ˆ ì¡°ì •
    upper_brown = np.array([25, 255, 240])  # H ê°’ì„ 20 â†’ 25ë¡œ ì¦ê°€, Vë¥¼ 230 â†’ 240ìœ¼ë¡œ ì¦ê°€


    # ë³‘ì§• ë¶€ë¶„ì„ í•„í„°ë§í•˜ëŠ” ë§ˆìŠ¤í¬ ìƒì„±
    mask_disease = cv2.inRange(hsv_image, lower_brown, upper_brown)
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (5, 5))
    mask_disease_cleaned = cv2.morphologyEx(mask_disease, cv2.MORPH_CLOSE, kernel)

    # ë³‘ì§• ìœ¤ê³½ì„  ê²€ì¶œ
    contours_disease, _ = cv2.findContours(mask_disease_cleaned, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # ì ë‚´ë¶€ì— ì™„ì „íˆ í¬í•¨ëœ ë³‘ì§•ë§Œ ìœ ì§€
    valid_disease_contours = []
    for disease_contour in contours_disease:
        if len(disease_contour) > 0:
            fully_inside = True  # ëª¨ë“  ì ì´ ì ë‚´ë¶€ì— ìˆì–´ì•¼ í•¨
            for point in disease_contour[:, 0, :]:
                point_tuple = tuple(map(int, point))
                inside_any_leaf = any(cv2.pointPolygonTest(leaf_contour, point_tuple, False) >= 0 for leaf_contour in leaf_contours)

                if not inside_any_leaf:
                    fully_inside = False  # í•˜ë‚˜ë¼ë„ ë°”ê¹¥ì´ë©´ ì œê±°
                    break

            if fully_inside:
                valid_disease_contours.append(disease_contour)

    return valid_disease_contours, mask_disease_cleaned


# ë³‘ì§• ë¶„ì„ (ëª…ë„ ê°’ ê³ ë ¤í•˜ì—¬ ì„¸ë¶€ êµ¬ë¶„)
def analyze_disease(contours_disease_all, leaf_area_mask, hsv_image):
    """
    ë³‘ì§•ì˜ ë©´ì ì„ ê³„ì‚°í•˜ê³ , ì „ì²´ ì ë©´ì  ëŒ€ë¹„ ë¹„ìœ¨ì„ êµ¬í•˜ì—¬ ì‹¬ê°ë„ë¥¼ í‰ê°€í•˜ëŠ” í•¨ìˆ˜.

    Args:
        contours_disease_all (list): ê²€ì¶œëœ ë³‘ì§• ìœ¤ê³½ì„  ë¦¬ìŠ¤íŠ¸
        leaf_area_mask (numpy.ndarray): ì ì˜ì—­ ë§ˆìŠ¤í¬
        hsv_image (numpy.ndarray): HSV ë³€í™˜ëœ ì´ë¯¸ì§€

    Returns:
        disease_ratio (float): ë³‘ì§• ë©´ì  ë¹„ìœ¨ (%)
        weighted_disease_ratio (float): ê°€ì¤‘ì¹˜ ì ìš©ëœ ë³‘ì§• ë©´ì  ë¹„ìœ¨ (%)
        severity (str): ë³‘ì§• ì‹¬ê°ë„ í‰ê°€ (ê²½ë¯¸, ì¤‘ê°„, ì‹¬ê°)
        area_dark_brown (float): ì–´ë‘ìš´ ê°ˆìƒ‰ ë³‘ì§• ë©´ì  ë¹„ìœ¨ (%)
        area_light_brown (float): ë°ì€ ê°ˆìƒ‰ ë³‘ì§• ë©´ì  ë¹„ìœ¨ (%)
        area_yellow (float): ë…¸ë€ìƒ‰ ë³‘ì§• ë©´ì  ë¹„ìœ¨ (%)
    """

    # âœ… ì „ì²´ ì ë©´ì  ê³„ì‚°
    leaf_area = np.sum(leaf_area_mask > 0)
    if leaf_area == 0:
        return None, None, "No Leaf Detected", 0, 0, 0

    # âœ… ë³‘ì§• ë§ˆìŠ¤í¬ ìƒì„± (HSV ê¸°ë°˜ + ëª…ë„ ê°’ ê³ ë ¤)
    lower_brown = np.array([5, 50, 20])    # ì „ì²´ ê°ˆìƒ‰ ë²”ìœ„ (ì–´ë‘ìš´/ë°ì€ êµ¬ë¶„ ì—†ì´)
    upper_brown = np.array([30, 255, 255])

    mask_brown = cv2.inRange(hsv_image, lower_brown, upper_brown)  # ê°ˆìƒ‰ í•„í„° ì ìš©

    # HSV ì±„ë„ ë¶„ë¦¬
    h, s, v = cv2.split(hsv_image)

    # âœ… **ì–´ë‘ìš´ ê°ˆìƒ‰ (V ê°’ì´ ë‚®ìŒ)**
    mask_dark_brown = cv2.bitwise_and(mask_brown, mask_brown, mask=((v < 150) & (s > 100)).astype(np.uint8) * 255)

    # âœ… **ë°ì€ ê°ˆìƒ‰ (V ê°’ì´ ë†’ìŒ)**
    mask_light_brown = cv2.bitwise_and(mask_brown, mask_brown, mask=((v >= 150) & (s < 200)).astype(np.uint8) * 255)

    # âœ… **ë…¸ë€ìƒ‰ í•„í„° (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)**
    lower_yellow = np.array([20, 100, 100])
    upper_yellow = np.array([35, 255, 255])
    mask_yellow = cv2.inRange(hsv_image, lower_yellow, upper_yellow)

    # âœ… ë³‘ì§• ìœ¤ê³½ì„  ë‚´ë¶€ ì˜ì—­ì„ ë§ˆìŠ¤í¬ë¡œ ìƒì„±
    mask_disease_contours = np.zeros_like(leaf_area_mask, dtype=np.uint8)
    cv2.drawContours(mask_disease_contours, contours_disease_all, -1, (255), thickness=cv2.FILLED)

    # âœ… **ìƒ‰ìƒë³„ ë³‘ì§• ë¹„ìœ¨ ê³„ì‚° (ì¤‘ë³µ ì œê±°)**
    total_disease_pixels = np.sum(mask_disease_contours > 0)
    if total_disease_pixels == 0:
        return 0, 0, "No Disease", 0, 0, 0

    # ê° ìƒ‰ìƒë³„ ë³‘ì§• ì˜ì—­ì´ ì„œë¡œ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì •
    mask_only_dark = cv2.bitwise_and(mask_dark_brown, mask_disease_contours)
    mask_only_light = cv2.bitwise_and(mask_light_brown, mask_disease_contours)
    mask_only_yellow = cv2.bitwise_and(mask_yellow, mask_disease_contours)

    # âœ… **í”½ì…€ ìˆ˜ ê¸°ë°˜ ë¹„ìœ¨ ê³„ì‚°**
    area_dark_brown = np.sum(mask_only_dark > 0)
    area_light_brown = np.sum(mask_only_light > 0)
    area_yellow = np.sum(mask_only_yellow > 0)

    # âœ… **ì´í•©ì„ 100%ë¡œ ì •ê·œí™”**
    total_area = area_dark_brown + area_light_brown + area_yellow
    if total_area > 0:
        area_dark_brown = (area_dark_brown / total_area) * 100
        area_light_brown = (area_light_brown / total_area) * 100
        area_yellow = (area_yellow / total_area) * 100
    else:
        area_dark_brown, area_light_brown, area_yellow = 0, 0, 0

    # âœ… **ì „ì²´ ë³‘ì§• ë©´ì  ë¹„ìœ¨ (ì ëŒ€ë¹„)**
    disease_ratio = (total_disease_pixels / leaf_area) * 100

    # âœ… **ê°€ì¤‘ì¹˜ ì ìš©ëœ ë³‘ì§• ë©´ì  ë¹„ìœ¨ ê³„ì‚°**
    weighted_disease_ratio = ((area_dark_brown * 1.5) + (area_light_brown * 1.2) + (area_yellow * 1.0)) / 100 * disease_ratio

    # âœ… **ë³‘ì§• ì‹¬ê°ë„ íŒë³„**
    severity = "ê²½ë¯¸" if weighted_disease_ratio < 10 else "ì¤‘ê°„" if weighted_disease_ratio < 30 else "ì‹¬ê°"

    return disease_ratio, weighted_disease_ratio, severity, area_dark_brown, area_light_brown, area_yellow




# ê²°ê³¼ ì‹œê°í™”
def visualize_results(image, contours_leaf_all, contours_disease):
    result_image = image.copy()

    # ì ìœ¤ê³½ì„  (ì´ˆë¡ìƒ‰)
    for contour in contours_leaf_all:
        cv2.drawContours(result_image, [contour], -1, (0, 255, 0), thickness=3)

    # ë³‘ì§• ìœ¤ê³½ì„  (ë¹¨ê°„ìƒ‰)
    for contour in contours_disease:
        cv2.drawContours(result_image, [contour], -1, (0, 0, 255), thickness=3)

    return result_image


# Colabì—ì„œ ì˜ë¼ë‚¸ 'ì´ë¯¸ì§€ 1ì¥'ì„ OpenCVë¡œ ì²˜ë¦¬
def main(image_path):
    resized_image, hsv_image, _ = preprocess_image(image_path)

    contours_leaf_all, leaf_mask_cleaned = detect_leaf_area(resized_image, hsv_image)
    contours_disease_all, disease_mask_cleaned = detect_disease_area(hsv_image, contours_leaf_all)

    # âœ… ë³‘ì§• ë¶„ì„ (ìƒ‰ìƒë³„ ë©´ì  í¬í•¨)
    disease_ratio, weighted_disease_ratio, severity_level, area_dark_brown, area_light_brown, area_yellow = analyze_disease(
        contours_disease_all, leaf_mask_cleaned, hsv_image
    )

    result_visualization = visualize_results(resized_image, contours_leaf_all, contours_disease_all)

    print(f" ë³‘ì§• ë¶„ì„ ê²°ê³¼:")
    print(f" - ì „ì²´ ë³‘ì§• ë©´ì  ë¹„ìœ¨: {disease_ratio:.2f}%")
    print(f" - ì–´ë‘ìš´ ê°ˆìƒ‰ ë³‘ì§• ë¹„ìœ¨: {area_dark_brown:.2f}%")
    print(f" - ë°ì€ ê°ˆìƒ‰ ë³‘ì§• ë¹„ìœ¨: {area_light_brown:.2f}%")
    print(f" - ë…¸ë€ìƒ‰ ë³‘ì§• ë¹„ìœ¨: {area_yellow:.2f}%")
    #print(f" - ì‹¬ê°ë„ : {weighted_disease_ratio:.2f}%")
    #print(f" - ì‹¬ê°ë„ íŒì •: {severity_level}")

    # Colabì—ì„œ ì´ë¯¸ì§€ ì¶œë ¥
    fig, axes = plt.subplots(1, 3, figsize=(15, 5))

    axes[0].imshow(cv2.cvtColor(resized_image, cv2.COLOR_BGR2RGB))
    axes[0].set_title("Original Image")
    axes[0].axis("off")

    axes[1].imshow(disease_mask_cleaned, cmap="gray")
    axes[1].set_title("Disease Mask")
    axes[1].axis("off")

    axes[2].imshow(cv2.cvtColor(result_visualization, cv2.COLOR_BGR2RGB))
    axes[2].set_title("Result Visualization")
    axes[2].axis("off")

    plt.show()



# ì‹¤í–‰: Faster R-CNNì´ ì˜ë¼ë‚¸ ë‹¨ì¼ ì´ë¯¸ì§€ ê²½ë¡œ ë„£ê¸°
image_path = "/content/drive/MyDrive/leafs/ulcer/ulcer_result/test10.JPG"
main(image_path)
